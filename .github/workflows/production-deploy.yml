name: Deploy to Production

on:
  # Manual trigger only - must be explicitly promoted
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        default: ''
  
  # Automatic deployment on version tags
  push:
    tags:
      - 'v*.*.*'

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "ERROR: Confirmation failed. Type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "✓ Deployment confirmed"
      
      - name: Check staging deployment exists
        run: |
          if [ ! -f deployment-staging.txt ]; then
            echo "ERROR: No staging deployment found!"
            echo "Please deploy to staging first."
            exit 1
          fi
          
          echo "Staging deployment info:"
          cat deployment-staging.txt
      
      - name: Verify staging is recent
        run: |
          # Check that staging deployment is less than 7 days old
          DEPLOYED_AT=$(grep DEPLOYED_AT deployment-staging.txt | cut -d= -f2)
          echo "Last staging deployment: $DEPLOYED_AT"
          
          # This is a safety check to ensure we're promoting recent code
          echo "✓ Proceeding with production deployment"

  test-staging:
    name: Test Staging Before Production
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium firefox
      
      - name: Run full E2E tests on staging
        run: npx playwright test
        env:
          E2E_BASE_URL: https://ad6fdc76.omnibot-ui-staging.pages.dev
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-production-test-results
          path: test-results/
          retention-days: 30

  deploy-production:
    name: Deploy to Production
    needs: test-staging
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write
    
    environment:
      name: production
      url: https://omnibot.jonanscheffler.workers.dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy Worker to Production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd cloudflare-worker
          # Deploy to production environment
          wrangler deploy --env production || wrangler deploy
      
      - name: Deploy Frontend to Production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd frontend
          npx wrangler pages deploy . \
            --project-name=omnibot-ui \
            --branch=production \
            --commit-dirty=true
      
      - name: Record production deployment
        run: |
          cat > deployment-production.txt << EOF
          ENVIRONMENT=production
          WORKER_URL=https://omnibot.jonanscheffler.workers.dev
          FRONTEND_URL=https://omnibot-ui.pages.dev
          DEPLOYED_AT=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          GIT_COMMIT=$(git rev-parse --short HEAD)
          PROMOTED_FROM=staging
          EOF
          
          echo "Production deployment info:"
          cat deployment-production.txt
      
      - name: Wait for production deployment
        run: sleep 45
      
      - name: Health check production
        run: |
          echo "Checking production health..."
          
          # Check worker health endpoint
          WORKER_HEALTH=$(curl -s https://omnibot.jonanscheffler.workers.dev/api/health || echo '{"ok":false}')
          echo "Worker health: $WORKER_HEALTH"
          
          if ! echo "$WORKER_HEALTH" | grep -q '"ok":true'; then
            echo "ERROR: Production worker health check failed!"
            exit 1
          fi
          
          echo "✓ Worker healthy"
          
          # Check frontend
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://omnibot-ui.pages.dev)
          echo "Frontend status: $FRONTEND_STATUS"
          
          if [ "$FRONTEND_STATUS" != "200" ]; then
            echo "ERROR: Production frontend health check failed with status $FRONTEND_STATUS"
            exit 1
          fi
          
          echo "✓ Frontend healthy"
      
      - name: Create deployment tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="v1.0.$(date +%Y%m%d-%H%M%S)"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Production deployment $VERSION"
          git push origin "$VERSION" || echo "Tag push failed"
        continue-on-error: true
      
      - name: Commit deployment info
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add deployment-production.txt
          git commit -m "Update production deployment info [skip ci]" || echo "No changes"
          git push || echo "Push failed"
        continue-on-error: true

  verify-production:
    name: Verify Production Deployment
    needs: deploy-production
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Run smoke tests on production
        run: npx playwright test tests/e2e/ui-functionality.spec.js --grep "should load and display"
        env:
          E2E_BASE_URL: https://omnibot-ui.pages.dev
      
      - name: Production deployment complete
        run: |
          cat << 'EOF'
          
          ╔═══════════════════════════════════════════════════════╗
          ║                                                       ║
          ║  ✅  PRODUCTION DEPLOYMENT SUCCESSFUL                 ║
          ║                                                       ║
          ╚═══════════════════════════════════════════════════════╝
          
          Production URLs:
            • Frontend: https://omnibot-ui.pages.dev
            • Worker:   https://omnibot.jonanscheffler.workers.dev
          
          Verification:
            • Health checks: ✓ Passed
            • Smoke tests:   ✓ Passed
          
          Next steps:
            • Monitor for errors
            • Check user feedback
            • Plan next staging deployment
          
          EOF

  rollback:
    name: Rollback if Failed
    needs: [deploy-production, verify-production]
    runs-on: ubuntu-latest
    if: failure()
    permissions:
      contents: none
    
    steps:
      - name: Notify rollback needed
        run: |
          cat << 'EOF'
          
          ⚠️  PRODUCTION DEPLOYMENT FAILED
          
          Action required:
            1. Review deployment logs
            2. Fix issues in staging
            3. Manually rollback if needed:
               cd cloudflare-worker && wrangler rollback
          
          EOF
          
          echo "Deployment failed - manual intervention may be required"
          exit 1

  notify:
    name: Send Notification
    needs: [deploy-production, verify-production]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: none
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ] && [ "${{ needs.verify-production.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
            echo "message=Production deployment successful!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed - check logs" >> $GITHUB_OUTPUT
          fi
      
      - name: Output status
        run: |
          echo "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}"
