name: Deploy to Staging

on:
  push:
    branches: [ staging, develop ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'test/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run structure tests
        run: npm run test:structure
        
      - name: Run safety tests
        run: npm run test:safety
      
      - name: Run all tests
        run: npm test
      
      - name: Validate worker code
        run: |
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Worker code size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "ERROR: Code too small!"
            exit 1
          fi
          echo "✓ Size check passed"

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy to Staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd cloudflare-worker
          # Deploy staging worker
          cat > wrangler.staging.toml << 'EOF'
          name = "omnibot-staging"
          main = "src/index.js"
          compatibility_date = "2024-01-01"
          EOF
          wrangler deploy --config wrangler.staging.toml
      
      - name: Wait for deployment
        run: sleep 20
      
      - name: Health check staging
        run: |
          RESPONSE=$(curl -s https://omnibot-staging.jonanscheffler.workers.dev/api/health)
          echo "Staging health: $RESPONSE"
          
          if ! echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "ERROR: Staging health check failed!"
            exit 1
          fi
          echo "✓ Staging deployment healthy"
      
      - name: Run functional tests against staging
        run: |
          # Test chat endpoint
          CHAT_RESPONSE=$(curl -s -X POST \
            https://omnibot-staging.jonanscheffler.workers.dev/api/chat \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"say hello"}]}')
          
          if ! echo "$CHAT_RESPONSE" | grep -q '"content"'; then
            echo "ERROR: Chat endpoint failed!"
            echo "Response: $CHAT_RESPONSE"
            exit 1
          fi
          echo "✓ Chat endpoint working"
          
          # Test edit validation
          EDIT_RESPONSE=$(curl -s -X POST \
            https://omnibot-staging.jonanscheffler.workers.dev/api/self-edit \
            -H "Content-Type: application/json" \
            -d '{"instruction":"test"}')
          
          if ! echo "$EDIT_RESPONSE" | grep -q "too short"; then
            echo "ERROR: Edit validation failed!"
            exit 1
          fi
          echo "✓ Edit validation working"
          
          # Test test endpoint
          TEST_RESPONSE=$(curl -s https://omnibot-staging.jonanscheffler.workers.dev/api/test)
          
          if ! echo "$TEST_RESPONSE" | grep -q '"ok":true'; then
            echo "ERROR: Test endpoint failed!"
            exit 1
          fi
          echo "✓ Test endpoint working"
