name: Test and Deploy OmniBot

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'test/**'
      - '.github/workflows/**'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install test dependencies
        run: |
          npm install
      
      - name: Run structure tests
        run: npm run test:structure
        
      - name: Run safety tests
        run: npm run test:safety
      
      - name: Run all tests
        run: npm test
      
      - name: Validate worker code size
        run: |
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Worker code size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "ERROR: Code too small ($SIZE bytes) - possible replacement attack!"
            exit 1
          fi
          echo "✓ Size check passed"
      
      - name: Check for browser APIs (Worker runtime only)
        run: |
          # Extract only Worker runtime code (before HTML template)
          # HTML templates contain client-side JS which is fine
          head -n 349 cloudflare-worker/src/index.js > /tmp/worker-runtime.js
          
          if grep -q "DOMParser\|window\.\|document\.\|localStorage\|sessionStorage" /tmp/worker-runtime.js; then
            echo "ERROR: Worker runtime contains browser APIs!"
            grep -n "DOMParser\|window\.\|document\.\|localStorage\|sessionStorage" /tmp/worker-runtime.js
            exit 1
          fi
          echo "✓ No browser APIs in Worker runtime"
      
      - name: Verify required functions exist
        run: |
          REQUIRED=(
            "async function selfEdit"
            "async function callGroq"
            "async function githubGet"
            "async function githubPut"
            "function validateCodeStructure"
            "export default"
          )
          
          for func in "${REQUIRED[@]}"; do
            if ! grep -q "$func" cloudflare-worker/src/index.js; then
              echo "ERROR: Missing required function: $func"
              exit 1
            fi
          done
          echo "✓ All required functions present"

  deploy:
    name: Deploy to Cloudflare
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: cloudflare-worker
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          RESPONSE=$(curl -s https://omnibot.jonanscheffler.workers.dev/api/health)
          echo "Health check response: $RESPONSE"
          
          if ! echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "ERROR: Health check failed!"
            exit 1
          fi
          echo "✓ Deployment healthy"
      
      - name: Test edit endpoint exists
        run: |
          RESPONSE=$(curl -s -X POST \
            https://omnibot.jonanscheffler.workers.dev/api/self-edit \
            -H "Content-Type: application/json" \
            -d '{"instruction":""}')
          
          if ! echo "$RESPONSE" | grep -q "too short"; then
            echo "ERROR: Edit endpoint not validating input!"
            exit 1
          fi
          echo "✓ Edit endpoint validation working"

  notify:
    name: Send notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi
      
      - name: Output status
        run: |
          echo "${{ steps.status.outputs.emoji }} Deploy status: ${{ steps.status.outputs.status }}"
