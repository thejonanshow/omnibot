name: Test and Deploy OmniBot

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'frontend/**'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build consolidated worker
        run: npm run build
      
      - name: Validate code exists
        run: |
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Code size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "ERROR: Code too small"
            exit 1
          fi
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd cloudflare-worker
          wrangler deploy
      
      - name: Health check
        run: |
          sleep 15
          curl -s https://omnibot.jonanscheffler.workers.dev/api/health
          echo "Deploy complete"
