name: Test and Deploy OmniBot

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'test/**'
      - '.github/workflows/**'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install test dependencies
        run: npm install
      
      - name: Run tests
        run: npm test
      
      - name: Validate worker code size
        run: |
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Worker code size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "ERROR: Code too small"
            exit 1
          fi
          echo "✓ Size check passed"
      
      - name: Check for browser APIs
        run: |
          HTML_START=$(grep -n "^const HTML = " cloudflare-worker/src/index.js | cut -d: -f1)
          if [ -z "$HTML_START" ]; then
            HTML_START=999999
          fi
          if head -$((HTML_START - 1)) cloudflare-worker/src/index.js | grep -q "DOMParser\|localStorage\|sessionStorage"; then
            echo "ERROR: Browser APIs in Worker code"
            exit 1
          fi
          echo "✓ No browser APIs"
      
      - name: Verify required functions
        run: |
          for func in "async function selfEdit" "async function callGroq" "export default"; do
            if ! grep -q "$func" cloudflare-worker/src/index.js; then
              echo "ERROR: Missing: $func"
              exit 1
            fi
          done
          echo "✓ Required functions present"

  deploy:
    name: Deploy to Cloudflare
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd cloudflare-worker
          wrangler deploy
      
      - name: Health check
        run: |
          sleep 15
          RESPONSE=$(curl -s https://omnibot.jonanscheffler.workers.dev/api/health)
          echo "Health: $RESPONSE"
          if ! echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "WARNING: Health check issue"
          fi
          echo "✓ Deploy complete"

  notify:
    name: Send notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Output status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deploy succeeded"
          else
            echo "❌ Deploy failed"
          fi
