name: Test and Deploy OmniBot

on:
  push:
    branches: [ main ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'test/**'
      - '.github/workflows/**'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install test dependencies
        run: |
          npm install
      
      - name: Run structure tests
        run: npm run test:structure
        
      - name: Run safety tests
        run: npm run test:safety
      
      - name: Run all tests
        run: npm test
      
      - name: Validate worker code size
        run: |
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Worker code size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "ERROR: Code too small ($SIZE bytes) - possible replacement attack!"
            exit 1
          fi
          echo "âœ“ Size check passed"
      
      - name: Check for browser APIs
        run: |
          if grep -q "DOMParser\|window\.\|document\.\|localStorage\|sessionStorage" cloudflare-worker/src/index.js; then
            echo "ERROR: Code contains browser-only APIs that don't work in Workers!"
            exit 1
          fi
          echo "âœ“ No browser APIs detected"
      
      - name: Verify required functions exist
        run: |
          REQUIRED=(
            "async function selfEdit"
            "async function callGroq"
            "async function githubGet"
            "async function githubPut"
            "function validateCodeStructure"
            "export default"
          )
          
          for func in "${REQUIRED[@]}"; do
            if ! grep -q "$func" cloudflare-worker/src/index.js; then
              echo "ERROR: Missing required function: $func"
              exit 1
            fi
          done
          echo "âœ“ All required functions present"

  deploy:
    name: Deploy to Cloudflare
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: cloudflare-worker
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          RESPONSE=$(curl -s https://omnibot.jonanscheffler.workers.dev/api/health)
          echo "Health check response: $RESPONSE"
          
          if ! echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "ERROR: Health check failed!"
            exit 1
          fi
          echo "âœ“ Deployment healthy"
      
      - name: Test edit endpoint exists
        run: |
          # Test that self-edit endpoint rejects empty instruction
          RESPONSE=$(curl -s -X POST \
            https://omnibot.jonanscheffler.workers.dev/api/self-edit \
            -H "Content-Type: application/json" \
            -d '{"instruction":""}')
          
          if ! echo "$RESPONSE" | grep -q "too short"; then
            echo "ERROR: Edit endpoint not validating input properly!"
            exit 1
          fi
          echo "âœ“ Edit endpoint validation working"
      
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Worker deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Edit endpoint validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ OmniBot is live at https://omnibot.jonanscheffler.workers.dev/" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Deployment successful" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Deployment failed - tests blocked deployment" >> $GITHUB_OUTPUT
          fi
      
      - name: Output status
        run: |
          echo "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
