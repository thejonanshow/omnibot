name: Deploy to Staging

on:
  push:
    branches: [ staging, develop ]
    paths:
      - 'cloudflare-worker/src/**'
      - 'frontend/**'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Lint code
        run: npm run lint
      
      - name: Pre-test validation
        run: |
          echo "Running pre-test validation checks..."
          
          # Check that the worker file exists
          if [ ! -f cloudflare-worker/src/index.js ]; then
            echo "ERROR: Worker source file not found"
            exit 1
          fi
          
          # Check file size
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Worker file size: $SIZE bytes"
          if [ $SIZE -lt 5000 ]; then
            echo "WARNING: Worker file seems unusually small (< 5KB)"
            echo "This may indicate an incomplete or corrupted file"
          fi
          
          # Check for critical patterns
          if ! grep -q "const HTML =" cloudflare-worker/src/index.js; then
            echo "WARNING: HTML UI constant not found"
            echo "This may cause test failures"
          fi
          
          if ! grep -q "export default" cloudflare-worker/src/index.js; then
            echo "ERROR: Missing default export"
            exit 1
          fi
          
          echo "✓ Pre-test validation passed"
      
      - name: Run tests
        run: npm test

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build consolidated worker
        run: npm run build
      
      - name: Verify build output
        run: |
          if [ ! -f cloudflare-worker/src/index.js ]; then
            echo "ERROR: Build did not produce index.js"
            exit 1
          fi
          SIZE=$(wc -c < cloudflare-worker/src/index.js)
          echo "Built worker size: $SIZE bytes"
          if [ $SIZE -lt 40000 ]; then
            echo "ERROR: Built worker is too small (expected >40KB with embedded HTML)"
            exit 1
          fi
          if ! grep -q "<!DOCTYPE html>" cloudflare-worker/src/index.js; then
            echo "ERROR: Built worker does not contain embedded HTML"
            exit 1
          fi
          echo "✓ Build verification passed"
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy to Staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd cloudflare-worker
          wrangler deploy --config wrangler.staging.toml
      
      - name: Post-deployment verification
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 30
          
          echo "Running post-deployment checks..."
          
          # Health check
          HEALTH=$(curl -sf https://omnibot-staging.jonanscheffler.workers.dev/api/health)
          if ! echo "$HEALTH" | grep -q '"ok":true'; then
            echo "ERROR: Health check failed"
            echo "Response: $HEALTH"
            exit 1
          fi
          echo "✓ Health check passed"
          
          # Verify HTML UI is served
          HTML_RESPONSE=$(curl -sf https://omnibot-staging.jonanscheffler.workers.dev/)
          if ! echo "$HTML_RESPONSE" | grep -q "<!DOCTYPE html>"; then
            echo "ERROR: HTML UI not served"
            exit 1
          fi
          if ! echo "$HTML_RESPONSE" | grep -q "Omnibot"; then
            echo "ERROR: HTML does not contain expected content"
            exit 1
          fi
          echo "✓ HTML UI verification passed"
          
          # Verify API endpoints exist
          curl -sf https://omnibot-staging.jonanscheffler.workers.dev/api/test > /dev/null
          echo "✓ Test endpoint accessible"
          
          echo "✅ Staging deployment verified successfully"
