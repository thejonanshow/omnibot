name: Deploy Omnibot with Full Observability

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable verbose debug mode'
        required: false
        default: 'true'
      environment:
        description: 'Deploy environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  SERVICE_NAME: omnibot
  NODE_VERSION: '20'
  WRANGLER_VERSION: '3'

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ job.status }}
      worker_url: ${{ steps.deploy-worker.outputs.url }}
      frontend_url: ${{ steps.deploy-frontend.outputs.url }}
      
    steps:
      # ============================================================
      # PHASE 1: SETUP & INFO GATHERING
      # ============================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather Comprehensive Pre-Deploy Info
        id: info
        run: |
          echo "=========================================="
          echo "ğŸ“‹ GATHERING DEPLOYMENT INFORMATION"
          echo "=========================================="
          
          # Basic commit info
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "commit_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "author_email=$(git log -1 --pretty=%ae)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          
          # Commit message
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Files changed with stats
          echo "files_changed<<EOF" >> $GITHUB_OUTPUT
          echo "=== FILES CHANGED ===" >> $GITHUB_OUTPUT
          git diff --name-status HEAD~1 HEAD 2>/dev/null || echo "First commit or shallow clone"
          echo "" >> $GITHUB_OUTPUT
          echo "=== CHANGE STATISTICS ===" >> $GITHUB_OUTPUT
          git diff --stat HEAD~1 HEAD 2>/dev/null || echo "No stats available"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Full diff (truncated for email)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          git diff HEAD~1 HEAD 2>/dev/null | head -1000 || echo "No diff available"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Environment info
          echo "runner_os=${{ runner.os }}" >> $GITHUB_OUTPUT
          echo "runner_arch=${{ runner.arch }}" >> $GITHUB_OUTPUT
          echo "node_version=${NODE_VERSION}" >> $GITHUB_OUTPUT
          
          # Determine deploy environment
          DEPLOY_ENV="${{ github.event.inputs.environment || 'staging' }}"
          echo "deploy_env=$DEPLOY_ENV" >> $GITHUB_OUTPUT
          
          echo "âœ… Info gathering complete"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Capture Complete Directory Structure
        id: structure
        run: |
          echo "=========================================="
          echo "ğŸ“ CAPTURING PROJECT STRUCTURE"
          echo "=========================================="
          
          echo "dir_structure<<EOF" >> $GITHUB_OUTPUT
          echo "=== COMPLETE PROJECT TREE ===" >> $GITHUB_OUTPUT
          find . -type f \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./cloudflare-worker/node_modules/*" \
            | sort >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "=== DIRECTORY SIZES ===" >> $GITHUB_OUTPUT
          du -sh */ 2>/dev/null || echo "No subdirectories"
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Structure captured"

      # ============================================================
      # PHASE 2: DEPENDENCY INSTALLATION
      # ============================================================
      - name: Install Root Dependencies
        id: install-root
        run: |
          echo "=========================================="
          echo "ğŸ“¦ INSTALLING ROOT DEPENDENCIES"
          echo "=========================================="
          
          echo "install_root_log<<EOF" >> $GITHUB_OUTPUT
          
          if [ -f "package-lock.json" ]; then
            echo "Found package-lock.json, using npm ci"
            npm ci 2>&1 | tee -a install_root.log || {
              echo "npm ci failed, falling back to npm install"
              npm install 2>&1 | tee -a install_root.log
            }
          elif [ -f "package.json" ]; then
            echo "No lock file, using npm install"
            npm install 2>&1 | tee -a install_root.log
          else
            echo "No package.json at root level"
          fi
          
          cat install_root.log >> $GITHUB_OUTPUT 2>/dev/null || echo "No install log"
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Root dependencies complete"

      - name: Install Cloudflare Worker Dependencies
        id: install-worker
        run: |
          echo "=========================================="
          echo "ğŸ“¦ INSTALLING WORKER DEPENDENCIES"
          echo "=========================================="
          
          echo "install_worker_log<<EOF" >> $GITHUB_OUTPUT
          
          cd cloudflare-worker
          
          if [ -f "package-lock.json" ]; then
            npm ci 2>&1 | tee install_worker.log || npm install 2>&1 | tee install_worker.log
          else
            npm install 2>&1 | tee install_worker.log
          fi
          
          # Also install wrangler globally for deployment
          npm install -g wrangler@${{ env.WRANGLER_VERSION }} 2>&1 | tee -a install_worker.log
          
          cat install_worker.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Worker dependencies complete"

      # ============================================================
      # PHASE 3: CODE QUALITY CHECKS
      # ============================================================
      - name: Run Linter
        id: lint
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ğŸ” RUNNING LINTER"
          echo "=========================================="
          
          echo "lint_log<<EOF" >> $GITHUB_OUTPUT
          
          # Check if lint script exists
          if grep -q '"lint"' package.json 2>/dev/null; then
            npm run lint 2>&1 | tee lint.log
            LINT_EXIT=$?
          else
            echo "âš ï¸ No lint script defined in root package.json"
            echo "Checking cloudflare-worker..."
            cd cloudflare-worker
            if grep -q '"lint"' package.json 2>/dev/null; then
              npm run lint 2>&1 | tee ../lint.log
              LINT_EXIT=$?
            else
              echo "âš ï¸ No lint script defined anywhere"
              echo "RECOMMENDATION: Add ESLint for code quality"
              LINT_EXIT=0
            fi
            cd ..
          fi
          
          cat lint.log >> $GITHUB_OUTPUT 2>/dev/null || echo "No lint output"
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "lint_status=$LINT_EXIT" >> $GITHUB_OUTPUT

      - name: Run Tests
        id: test
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ğŸ§ª RUNNING TESTS"
          echo "=========================================="
          
          echo "test_log<<EOF" >> $GITHUB_OUTPUT
          
          # Check for test files
          TEST_FILES=$(find . -name "*.test.js" -o -name "*.spec.js" | grep -v node_modules | head -20)
          
          if [ -z "$TEST_FILES" ]; then
            echo "âš ï¸ NO TEST FILES FOUND"
            echo ""
            echo "Searched for: *.test.js, *.spec.js"
            echo "This is a code quality issue - tests should exist!"
            echo ""
            echo "RECOMMENDATION: Add tests to ensure code reliability"
            TEST_EXIT=0
          else
            echo "Found test files:"
            echo "$TEST_FILES"
            echo ""
            
            if grep -q '"test"' package.json 2>/dev/null; then
              npm test 2>&1 | tee test.log
              TEST_EXIT=$?
            else
              echo "âš ï¸ No test script in package.json"
              TEST_EXIT=0
            fi
          fi
          
          cat test.log >> $GITHUB_OUTPUT 2>/dev/null || echo "No test output"
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "test_status=$TEST_EXIT" >> $GITHUB_OUTPUT

      - name: Validate Worker Code
        id: validate
        run: |
          echo "=========================================="
          echo "âœ… VALIDATING WORKER CODE"
          echo "=========================================="
          
          echo "validate_log<<EOF" >> $GITHUB_OUTPUT
          
          cd cloudflare-worker
          
          # Check for required files
          echo "=== CHECKING REQUIRED FILES ==="
          
          MISSING_FILES=""
          
          if [ ! -f "src/index.js" ]; then
            echo "âŒ CRITICAL: src/index.js not found!"
            MISSING_FILES="$MISSING_FILES src/index.js"
          else
            echo "âœ… src/index.js exists"
          fi
          
          if [ ! -f "wrangler.toml" ]; then
            echo "âŒ CRITICAL: wrangler.toml not found!"
            MISSING_FILES="$MISSING_FILES wrangler.toml"
          else
            echo "âœ… wrangler.toml exists"
          fi
          
          # Check for imported modules
          echo ""
          echo "=== CHECKING IMPORTED MODULES ==="
          
          if [ -f "src/index.js" ]; then
            IMPORTS=$(grep "^import" src/index.js || echo "")
            echo "Found imports:"
            echo "$IMPORTS"
            echo ""
            
            # Check each local import
            echo "$IMPORTS" | grep "from '\.\/" | while read -r line; do
              MODULE=$(echo "$line" | sed "s/.*from '\(\.\/[^']*\)'.*/\1/")
              if [ ! -f "src/${MODULE#./}" ]; then
                echo "âš ï¸ WARNING: Imported module not found: $MODULE"
              else
                echo "âœ… Found: $MODULE"
              fi
            done
          fi
          
          # Syntax check with Node
          echo ""
          echo "=== SYNTAX VALIDATION ==="
          node --check src/index.js 2>&1 && echo "âœ… Syntax OK" || echo "âŒ Syntax errors detected"
          
          # Check wrangler config
          echo ""
          echo "=== WRANGLER CONFIG ==="
          cat wrangler.toml
          
          cd ..
          
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -n "$MISSING_FILES" ]; then
            echo "validate_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Validation failed - missing critical files"
            exit 1
          else
            echo "validate_status=passed" >> $GITHUB_OUTPUT
            echo "âœ… Validation passed"
          fi

      # ============================================================
      # PHASE 4: DEPLOYMENT
      # ============================================================
      - name: Deploy Cloudflare Worker
        id: deploy-worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=========================================="
          echo "ğŸš€ DEPLOYING CLOUDFLARE WORKER"
          echo "=========================================="
          
          DEPLOY_ENV="${{ steps.info.outputs.deploy_env }}"
          
          echo "worker_deploy_log<<EOF" >> $GITHUB_OUTPUT
          
          cd cloudflare-worker
          
          echo "Environment: $DEPLOY_ENV"
          echo "Account ID: ${CLOUDFLARE_ACCOUNT_ID:0:8}..."
          echo ""
          
          # Deploy with verbose output
          if [ "$DEPLOY_ENV" = "production" ]; then
            echo "ğŸ”´ DEPLOYING TO PRODUCTION"
            DEPLOY_OUTPUT=$(npx wrangler deploy --env production 2>&1) || {
              echo "âŒ Deployment failed!"
              echo "$DEPLOY_OUTPUT"
              echo "$DEPLOY_OUTPUT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "worker_status=failed" >> $GITHUB_OUTPUT
              exit 1
            }
          else
            echo "ğŸŸ¡ DEPLOYING TO STAGING"
            DEPLOY_OUTPUT=$(npx wrangler deploy --env staging 2>&1) || {
              echo "âŒ Deployment failed!"
              echo "$DEPLOY_OUTPUT"
              echo "$DEPLOY_OUTPUT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "worker_status=failed" >> $GITHUB_OUTPUT
              exit 1
            }
          fi
          
          echo "$DEPLOY_OUTPUT"
          echo "$DEPLOY_OUTPUT" >> $GITHUB_OUTPUT
          
          # Extract worker URL
          WORKER_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[^ ]+\.workers\.dev' | head -1)
          
          if [ -z "$WORKER_URL" ]; then
            echo "âš ï¸ Could not extract worker URL from output"
            WORKER_URL="https://omnibot-router-${DEPLOY_ENV}.workers.dev"
          fi
          
          echo ""
          echo "âœ… Worker deployed: $WORKER_URL"
          
          echo "EOF" >> $GITHUB_OUTPUT
          echo "url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "worker_status=success" >> $GITHUB_OUTPUT
          
          cd ..

      - name: Deploy Frontend to Cloudflare Pages
        id: deploy-frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=========================================="
          echo "ğŸ¨ DEPLOYING FRONTEND"
          echo "=========================================="
          
          DEPLOY_ENV="${{ steps.info.outputs.deploy_env }}"
          
          echo "frontend_deploy_log<<EOF" >> $GITHUB_OUTPUT
          
          cd frontend
          
          # Determine project name
          if [ "$DEPLOY_ENV" = "production" ]; then
            PAGES_PROJECT="omnibot-ui"
          else
            PAGES_PROJECT="omnibot-ui-staging"
          fi
          
          echo "Pages Project: $PAGES_PROJECT"
          echo ""
          
          # Deploy to Pages
          FRONTEND_OUTPUT=$(npx wrangler pages deploy . --project-name $PAGES_PROJECT --commit-dirty=true 2>&1) || {
            echo "âš ï¸ Pages deployment issue (may need project creation)"
            echo "$FRONTEND_OUTPUT"
          }
          
          echo "$FRONTEND_OUTPUT"
          echo "$FRONTEND_OUTPUT" >> $GITHUB_OUTPUT
          
          # Extract URL
          FRONTEND_URL=$(echo "$FRONTEND_OUTPUT" | grep -oE 'https://[^ ]+\.pages\.dev' | head -1)
          
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL="https://${PAGES_PROJECT}.pages.dev"
          fi
          
          echo ""
          echo "âœ… Frontend deployed: $FRONTEND_URL"
          
          echo "EOF" >> $GITHUB_OUTPUT
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          cd ..

      # ============================================================
      # PHASE 5: POST-DEPLOY VERIFICATION
      # ============================================================
      - name: Health Check - Worker
        id: health-worker
        if: steps.deploy-worker.outputs.worker_status == 'success'
        run: |
          echo "=========================================="
          echo "ğŸ¥ WORKER HEALTH CHECK"
          echo "=========================================="
          
          WORKER_URL="${{ steps.deploy-worker.outputs.url }}"
          
          echo "health_worker_log<<EOF" >> $GITHUB_OUTPUT
          
          # Wait for deployment to propagate
          echo "Waiting 30s for deployment to propagate..."
          sleep 30
          
          # Test health endpoint
          echo "=== /health endpoint ==="
          HEALTH_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}s" "$WORKER_URL/health" 2>&1)
          echo "$HEALTH_RESPONSE"
          
          HEALTH_CODE=$(echo "$HEALTH_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          echo ""
          
          # Test status endpoint
          echo "=== /status endpoint ==="
          STATUS_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}s" "$WORKER_URL/status" 2>&1)
          echo "$STATUS_RESPONSE"
          
          STATUS_CODE=$(echo "$STATUS_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          echo ""
          
          # Test challenge endpoint
          echo "=== /challenge endpoint ==="
          CHALLENGE_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}s" "$WORKER_URL/challenge" 2>&1)
          echo "$CHALLENGE_RESPONSE"
          
          CHALLENGE_CODE=$(echo "$CHALLENGE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          echo ""
          
          # Test 404 handling
          echo "=== 404 handling ==="
          NOT_FOUND=$(curl -sS -w "\nHTTP_CODE:%{http_code}" "$WORKER_URL/nonexistent" 2>&1)
          echo "$NOT_FOUND"
          
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "health_code=$HEALTH_CODE" >> $GITHUB_OUTPUT
          echo "status_code=$STATUS_CODE" >> $GITHUB_OUTPUT
          echo "challenge_code=$CHALLENGE_CODE" >> $GITHUB_OUTPUT

      - name: Health Check - Frontend
        id: health-frontend
        run: |
          echo "=========================================="
          echo "ğŸ¥ FRONTEND HEALTH CHECK"
          echo "=========================================="
          
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.url }}"
          
          echo "health_frontend_log<<EOF" >> $GITHUB_OUTPUT
          
          echo "=== Main page ==="
          MAIN_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}s\nSIZE:%{size_download}bytes" "$FRONTEND_URL" 2>&1 | tail -10)
          echo "$MAIN_RESPONSE"
          
          MAIN_CODE=$(echo "$MAIN_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          echo "EOF" >> $GITHUB_OUTPUT
          echo "frontend_code=$MAIN_CODE" >> $GITHUB_OUTPUT

      # ============================================================
      # PHASE 6: CAPTURE CODEBASE SNAPSHOT FOR CLAUDE
      # ============================================================
      - name: Capture Full Codebase Snapshot
        id: snapshot
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“¸ CAPTURING CODEBASE SNAPSHOT"
          echo "=========================================="
          
          # Root package.json
          echo "root_package_json<<EOF" >> $GITHUB_OUTPUT
          cat package.json 2>/dev/null || echo "No root package.json"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Worker package.json
          echo "worker_package_json<<EOF" >> $GITHUB_OUTPUT
          cat cloudflare-worker/package.json 2>/dev/null || echo "No worker package.json"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Wrangler config
          echo "wrangler_toml<<EOF" >> $GITHUB_OUTPUT
          cat cloudflare-worker/wrangler.toml 2>/dev/null || echo "No wrangler.toml"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Main worker code (full file - critical for debugging)
          echo "worker_index_js<<EOF" >> $GITHUB_OUTPUT
          cat cloudflare-worker/src/index.js 2>/dev/null || echo "No index.js"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Supporting worker files
          echo "worker_other_files<<EOF" >> $GITHUB_OUTPUT
          echo "=== cloudflare-worker/src/ contents ==="
          ls -la cloudflare-worker/src/ 2>/dev/null || echo "No src directory"
          echo ""
          for f in cloudflare-worker/src/*.js; do
            if [ -f "$f" ] && [ "$f" != "cloudflare-worker/src/index.js" ]; then
              echo "=== $f ==="
              cat "$f"
              echo ""
            fi
          done
          echo "=== cloudflare-worker/src/lib/ ==="
          for f in cloudflare-worker/src/lib/*.js; do
            if [ -f "$f" ]; then
              echo "=== $f ==="
              cat "$f"
              echo ""
            fi
          done 2>/dev/null || echo "No lib directory"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Frontend HTML (first 500 lines for size)
          echo "frontend_html<<EOF" >> $GITHUB_OUTPUT
          head -500 frontend/index.html 2>/dev/null || echo "No frontend/index.html"
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Any test files
          echo "test_files<<EOF" >> $GITHUB_OUTPUT
          find . -name "*.test.js" -o -name "*.spec.js" | grep -v node_modules | while read f; do
            echo "=== $f ==="
            cat "$f" 2>/dev/null
            echo ""
          done
          echo "EOF" >> $GITHUB_OUTPUT

      # ============================================================
      # PHASE 7: SEND EMAIL REPORT
      # ============================================================
      - name: Generate and Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "[${{ env.SERVICE_NAME }}] Deploy ${{ job.status }} - ${{ steps.info.outputs.commit_short }} (${{ steps.info.outputs.deploy_env }})"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.GMAIL_USER }}
          content_type: text/plain
          body: |
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘                    OMNIBOT DEPLOY REPORT                         â•‘
            â•‘              Claude-Readable Observability Format                â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ DEPLOYMENT SUMMARY                                              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            STATUS:       ${{ job.status }}
            ENVIRONMENT:  ${{ steps.info.outputs.deploy_env }}
            TIMESTAMP:    ${{ steps.info.outputs.timestamp }}
            COMMIT:       ${{ steps.info.outputs.commit_sha }}
            BRANCH:       ${{ steps.info.outputs.branch }}
            AUTHOR:       ${{ steps.info.outputs.author }} <${{ steps.info.outputs.author_email }}>
            
            WORKER URL:   ${{ steps.deploy-worker.outputs.url }}
            FRONTEND URL: ${{ steps.deploy-frontend.outputs.url }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ COMMIT MESSAGE                                                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.info.outputs.commit_msg }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ HEALTH CHECK RESULTS                                            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            Worker /health:    HTTP ${{ steps.health-worker.outputs.health_code || 'N/A' }}
            Worker /status:    HTTP ${{ steps.health-worker.outputs.status_code || 'N/A' }}
            Worker /challenge: HTTP ${{ steps.health-worker.outputs.challenge_code || 'N/A' }}
            Frontend:          HTTP ${{ steps.health-frontend.outputs.frontend_code || 'N/A' }}
            
            HEALTH CHECK DETAILS:
            ${{ steps.health-worker.outputs.health_worker_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ FILES CHANGED                                                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.info.outputs.files_changed }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ CODE VALIDATION                                                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.validate.outputs.validate_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LINT OUTPUT                                                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            Exit Code: ${{ steps.lint.outputs.lint_status }}
            
            ${{ steps.lint.outputs.lint_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ TEST OUTPUT                                                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            Exit Code: ${{ steps.test.outputs.test_status }}
            
            ${{ steps.test.outputs.test_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ WORKER DEPLOYMENT LOG                                           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.deploy-worker.outputs.worker_deploy_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ FRONTEND DEPLOYMENT LOG                                         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.deploy-frontend.outputs.frontend_deploy_log }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ PROJECT STRUCTURE                                               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.structure.outputs.dir_structure }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ROOT package.json                                               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.root_package_json }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ WORKER package.json                                             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.worker_package_json }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ wrangler.toml                                                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.wrangler_toml }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ WORKER CODE: cloudflare-worker/src/index.js                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.worker_index_js }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ OTHER WORKER FILES                                              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.worker_other_files }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ FRONTEND: index.html (first 500 lines)                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.frontend_html }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ TEST FILES                                                      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.snapshot.outputs.test_files }}
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ CODE DIFF (truncated to 1000 lines)                             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            
            ${{ steps.info.outputs.diff }}
            
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘ LINKS                                                            â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘ Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â•‘ Commit:       https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            â•‘ Repository:   https://github.com/${{ github.repository }}
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ---
            This report was auto-generated for Claude AI observability.
            Search Gmail for "[${{ env.SERVICE_NAME }}] Deploy" to find deploy reports.
