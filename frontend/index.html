<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omnibot - AI Assistant</title>
    <style id="theme-styles">
        /* Base styles with CSS Variables for theming */
        :root {
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ========================================
           MATRIX THEME (Updated Modern Style)
           ======================================== */
        body.theme-matrix {
            --bg-primary: #000000;
            --bg-secondary: #001a00;
            --bg-tertiary: #002200;
            --text-primary: #00ff00;
            --text-secondary: #00cc00;
            --text-muted: #008800;
            --accent-primary: #00ff00;
            --accent-secondary: #00ff00;
            --border-color: #003300;
            --message-user-bg: #002200;
            --message-ai-bg: #001100;
            --message-system-bg: #1a1a00;
            --input-bg: #001100;
            --button-bg: #002200;
            --button-hover-bg: #00ff00;
            --button-hover-text: #000000;
            --shadow-sm: 0 0 10px rgba(0, 255, 0, 0.1);
            --shadow-md: 0 0 20px rgba(0, 255, 0, 0.2);
            --shadow-lg: 0 0 30px rgba(0, 255, 0, 0.3);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', 'Consolas', monospace;
        }
        
        /* ========================================
           CYBERPUNK THEME (Enhanced)
           ======================================== */
        body.theme-cyberpunk {
            --bg-primary: #0a0a1a;
            --bg-secondary: #1a0a2a;
            --bg-tertiary: #2a0a3a;
            --text-primary: #ff00ff;
            --text-secondary: #cc00cc;
            --text-muted: #aa00aa;
            --accent-primary: #00ffff;
            --accent-secondary: #ff00ff;
            --border-color: #3a0a4a;
            --message-user-bg: linear-gradient(135deg, #1a0a2a 0%, #2a0a3a 100%);
            --message-ai-bg: linear-gradient(135deg, #15051f 0%, #1a0a2a 100%);
            --message-system-bg: #2a1a00;
            --input-bg: #0a0a1a;
            --button-bg: #1a0a2a;
            --button-hover-bg: #ff00ff;
            --button-hover-text: #000000;
            --shadow-sm: 0 4px 12px rgba(255, 0, 255, 0.15);
            --shadow-md: 0 8px 24px rgba(255, 0, 255, 0.25);
            --shadow-lg: 0 12px 36px rgba(255, 0, 255, 0.35);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           BORG THEME (Enhanced with glow)
           ======================================== */
        body.theme-borg {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #00ff00;
            --text-secondary: #00dd00;
            --text-muted: #00aa00;
            --accent-primary: #00ff00;
            --accent-secondary: #00ff00;
            --border-color: #2a2a2a;
            --message-user-bg: #1a1a1a;
            --message-ai-bg: #151515;
            --message-system-bg: #1a1a00;
            --input-bg: #0f0f0f;
            --button-bg: #1a1a1a;
            --button-hover-bg: #00ff00;
            --button-hover-text: #000000;
            --shadow-sm: 0 0 15px rgba(0, 255, 0, 0.2);
            --shadow-md: 0 0 25px rgba(0, 255, 0, 0.3);
            --shadow-lg: 0 0 35px rgba(0, 255, 0, 0.4);
            background: var(--bg-primary);
            color: var(--text-primary);
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        /* ========================================
           HAL 9000 THEME
           ======================================== */
        body.theme-hal {
            --bg-primary: #000000;
            --bg-secondary: #1a0000;
            --bg-tertiary: #2a0000;
            --text-primary: #ff0000;
            --text-secondary: #dd0000;
            --text-muted: #aa0000;
            --accent-primary: #ff0000;
            --accent-secondary: #ff3333;
            --border-color: #330000;
            --message-user-bg: #1a0000;
            --message-ai-bg: #150000;
            --message-system-bg: #1a1a00;
            --input-bg: #0a0000;
            --button-bg: #1a0000;
            --button-hover-bg: #ff0000;
            --button-hover-text: #000000;
            --shadow-sm: 0 0 10px rgba(255, 0, 0, 0.15);
            --shadow-md: 0 0 20px rgba(255, 0, 0, 0.25);
            --shadow-lg: 0 0 30px rgba(255, 0, 0, 0.35);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           WAR GAMES THEME
           ======================================== */
        body.theme-wargames {
            --bg-primary: #000000;
            --bg-secondary: #001100;
            --bg-tertiary: #002200;
            --text-primary: #00ff00;
            --text-secondary: #00dd00;
            --text-muted: #00aa00;
            --accent-primary: #00ff00;
            --accent-secondary: #00ff00;
            --border-color: #003300;
            --message-user-bg: #001100;
            --message-ai-bg: #000a00;
            --message-system-bg: #110000;
            --input-bg: #000800;
            --button-bg: #001100;
            --button-hover-bg: #00ff00;
            --button-hover-text: #000000;
            --shadow-sm: 0 2px 8px rgba(0, 255, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 255, 0, 0.15);
            --shadow-lg: 0 6px 24px rgba(0, 255, 0, 0.2);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }
        
        /* ========================================
           MODERN DARK THEME (Significantly Enhanced)
           ======================================== */
        body.theme-modern {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --text-muted: #888888;
            --accent-primary: #4a9eff;
            --accent-secondary: #357abd;
            --border-color: #2a2a2a;
            --message-user-bg: linear-gradient(135deg, #2d4a6e 0%, #1e3a5f 100%);
            --message-ai-bg: #1a1a1a;
            --message-system-bg: #3d3d1a;
            --input-bg: #1a1a1a;
            --button-bg: #2a2a2a;
            --button-hover-bg: #3a3a3a;
            --button-hover-text: #ffffff;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           TRON LEGACY THEME (NEW)
           ======================================== */
        body.theme-tron {
            --bg-primary: #000000;
            --bg-secondary: #001015;
            --bg-tertiary: #001520;
            --text-primary: #00D9FF;
            --text-secondary: #00b8dd;
            --text-muted: #0088aa;
            --accent-primary: #00D9FF;
            --accent-secondary: #00b8dd;
            --border-color: #00D9FF;
            --message-user-bg: linear-gradient(135deg, #001520 0%, #002030 100%);
            --message-ai-bg: #000a0f;
            --message-system-bg: #001520;
            --input-bg: #000508;
            --button-bg: #001015;
            --button-hover-bg: #00D9FF;
            --button-hover-text: #000000;
            --shadow-sm: 0 0 15px rgba(0, 217, 255, 0.3);
            --shadow-md: 0 0 25px rgba(0, 217, 255, 0.4);
            --shadow-lg: 0 0 35px rgba(0, 217, 255, 0.5);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           NEUROMANCER THEME (NEW)
           ======================================== */
        body.theme-neuromancer {
            --bg-primary: #0a0015;
            --bg-secondary: #1a0025;
            --bg-tertiary: #2a0035;
            --text-primary: #FF00D4;
            --text-secondary: #dd00bb;
            --text-muted: #aa0088;
            --accent-primary: #9B4F96;
            --accent-secondary: #FF00D4;
            --border-color: #3a0045;
            --message-user-bg: linear-gradient(135deg, #2a0035 0%, #3a0045 100%);
            --message-ai-bg: linear-gradient(135deg, #1a0025 0%, #2a0035 100%);
            --message-system-bg: #2a1a00;
            --input-bg: #0a0015;
            --button-bg: #1a0025;
            --button-hover-bg: #FF00D4;
            --button-hover-text: #000000;
            --shadow-sm: 0 4px 16px rgba(255, 0, 212, 0.2);
            --shadow-md: 0 8px 24px rgba(155, 79, 150, 0.3);
            --shadow-lg: 0 12px 36px rgba(255, 0, 212, 0.4);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           ALIEN ISOLATION THEME (NEW)
           ======================================== */
        body.theme-alien {
            --bg-primary: #000000;
            --bg-secondary: #0a1100;
            --bg-tertiary: #0f1a00;
            --text-primary: #33FF00;
            --text-secondary: #2acc00;
            --text-muted: #1a8800;
            --accent-primary: #33FF00;
            --accent-secondary: #ffaa00;
            --border-color: #1a3300;
            --message-user-bg: #0a1100;
            --message-ai-bg: #050800;
            --message-system-bg: #1a1a00;
            --input-bg: #000000;
            --button-bg: #0a1100;
            --button-hover-bg: #33FF00;
            --button-hover-text: #000000;
            --shadow-sm: 0 2px 8px rgba(51, 255, 0, 0.15);
            --shadow-md: 0 4px 16px rgba(51, 255, 0, 0.25);
            --shadow-lg: 0 6px 24px rgba(51, 255, 0, 0.35);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', 'OCR A', monospace;
        }
        
        /* ========================================
           DUNE THEME (NEW)
           ======================================== */
        body.theme-dune {
            --bg-primary: #1a1410;
            --bg-secondary: #2a2418;
            --bg-tertiary: #3a3420;
            --text-primary: #D4A574;
            --text-secondary: #b8895f;
            --text-muted: #8B6635;
            --accent-primary: #0077BE;
            --accent-secondary: #D4A574;
            --border-color: #3a3420;
            --message-user-bg: linear-gradient(135deg, #2a2418 0%, #3a3420 100%);
            --message-ai-bg: #25201a;
            --message-system-bg: #2a2010;
            --input-bg: #1a1410;
            --button-bg: #2a2418;
            --button-hover-bg: #0077BE;
            --button-hover-text: #ffffff;
            --shadow-sm: 0 2px 12px rgba(0, 119, 190, 0.15);
            --shadow-md: 0 4px 20px rgba(0, 119, 190, 0.25);
            --shadow-lg: 0 6px 28px rgba(0, 119, 190, 0.35);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* ========================================
           GHOST IN THE SHELL THEME (NEW)
           ======================================== */
        body.theme-ghost {
            --bg-primary: #0a0f15;
            --bg-secondary: #0f1520;
            --bg-tertiary: #15202a;
            --text-primary: #00E5FF;
            --text-secondary: #00c5dd;
            --text-muted: #0088aa;
            --accent-primary: #6E00FF;
            --accent-secondary: #00E5FF;
            --border-color: #1a2530;
            --message-user-bg: linear-gradient(135deg, #15202a 0%, #1a2535 100%);
            --message-ai-bg: linear-gradient(135deg, #0f1520 0%, #15202a 100%);
            --message-system-bg: #1a1520;
            --input-bg: rgba(15, 21, 32, 0.8);
            --button-bg: rgba(20, 30, 40, 0.8);
            --button-hover-bg: #6E00FF;
            --button-hover-text: #ffffff;
            --shadow-sm: 0 4px 16px rgba(110, 0, 255, 0.2);
            --shadow-md: 0 8px 24px rgba(0, 229, 255, 0.25);
            --shadow-lg: 0 12px 36px rgba(110, 0, 255, 0.3);
            background: var(--bg-primary);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }
        
        /* ========================================
           INTERSTELLAR THEME (NEW)
           ======================================== */
        body.theme-interstellar {
            --bg-primary: #0A1128;
            --bg-secondary: #0f1830;
            --bg-tertiary: #152038;
            --text-primary: #e8f4ff;
            --text-secondary: #b8d4ee;
            --text-muted: #88a4c4;
            --accent-primary: #4a9eff;
            --accent-secondary: #7ab8ff;
            --border-color: #1a2840;
            --message-user-bg: linear-gradient(135deg, #152038 0%, #1a2840 100%);
            --message-ai-bg: #0f1830;
            --message-system-bg: #1a2030;
            --input-bg: #0A1128;
            --button-bg: #152038;
            --button-hover-bg: #4a9eff;
            --button-hover-text: #000000;
            --shadow-sm: 0 2px 12px rgba(74, 158, 255, 0.15);
            --shadow-md: 0 4px 20px rgba(74, 158, 255, 0.25);
            --shadow-lg: 0 6px 28px rgba(74, 158, 255, 0.35);
            background: radial-gradient(ellipse at center, #0f1830 0%, #0A1128 100%);
            color: var(--text-primary);
        }
        
        /* ========================================
           SYNTHWAVE THEME (NEW)
           ======================================== */
        body.theme-synthwave {
            --bg-primary: #1a0a2e;
            --bg-secondary: #2a1545;
            --bg-tertiary: #3a205a;
            --text-primary: #FF0090;
            --text-secondary: #dd007a;
            --text-muted: #aa0060;
            --accent-primary: #00FFFF;
            --accent-secondary: #FF0090;
            --border-color: #4a2570;
            --message-user-bg: linear-gradient(135deg, #2a1545 0%, #3a205a 100%);
            --message-ai-bg: linear-gradient(135deg, #1a0a2e 0%, #2a1545 100%);
            --message-system-bg: #2a1a00;
            --input-bg: #1a0a2e;
            --button-bg: #2a1545;
            --button-hover-bg: linear-gradient(135deg, #FF0090 0%, #00FFFF 100%);
            --button-hover-text: #000000;
            --shadow-sm: 0 4px 16px rgba(255, 0, 144, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 255, 255, 0.3);
            --shadow-lg: 0 12px 36px rgba(255, 0, 144, 0.4);
            background: linear-gradient(180deg, #1a0a2e 0%, #2a1545 100%);
            color: var(--text-primary);
        }
        
        /* ========================================
           PORTAL THEME (NEW)
           ======================================== */
        body.theme-portal {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #2a2a2a;
            --text-secondary: #5a5a5a;
            --text-muted: #8a8a8a;
            --accent-primary: #FF8C00;
            --accent-secondary: #0096FF;
            --border-color: #d0d0d0;
            --message-user-bg: linear-gradient(135deg, #0096FF 0%, #0077cc 100%);
            --message-ai-bg: #ffffff;
            --message-system-bg: #fff8e8;
            --input-bg: #ffffff;
            --button-bg: #e8e8e8;
            --button-hover-bg: #FF8C00;
            --button-hover-text: #ffffff;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        body.theme-portal .message.user {
            color: #ffffff;
        }
        
        /* ========================================
           HEADER STYLES
           ======================================== */
        .header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .connection-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }
        
        .status-bar {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 0.813rem;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }
        
        .status-label {
            opacity: 0.7;
            font-weight: 500;
        }
        
        .status-value {
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .controls {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 18px;
            background: var(--button-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            white-space: nowrap;
        }
        
        button:hover:not(:disabled) {
            background: var(--button-hover-bg);
            color: var(--button-hover-text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* ========================================
           CHAT CONTAINER
           ======================================== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--spacing-lg);
            scroll-behavior: smooth;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }
        
        /* ========================================
           MESSAGE BUBBLES (Modern Design)
           ======================================== */
        .message {
            max-width: 700px;
            margin: 0 auto var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            line-height: 1.6;
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background: var(--message-user-bg);
            margin-left: auto;
            margin-right: 0;
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-sm);
        }
        
        .message.assistant {
            background: var(--message-ai-bg);
            margin-left: 0;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .message.system,
        .message.error {
            background: var(--message-system-bg);
            text-align: center;
            font-size: 0.875rem;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            max-width: 600px;
        }
        
        .message.error {
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .message-role {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .message-role::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-primary);
        }
        
        .message-content {
            word-wrap: break-word;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            opacity: 0.5;
            margin-top: var(--spacing-sm);
            text-align: right;
        }
        
        /* Loading indicator (typing animation) */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--message-ai-bg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            max-width: 80px;
            margin: 0 auto var(--spacing-lg);
            margin-left: 0;
            margin-right: auto;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* ========================================
           INPUT AREA (Enhanced with Secondary Buttons)
           ======================================== */
        .input-container {
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .input-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .input-wrapper {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
        }
        
        .secondary-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .secondary-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            white-space: nowrap;
        }
        
        .secondary-btn:hover:not(:disabled) {
            background: var(--button-hover-bg);
            color: var(--button-hover-text);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: 0 0 12px var(--accent-primary);
        }
        
        .secondary-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 16px var(--accent-primary);
            font-weight: 600;
        }
        
        .secondary-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        textarea {
            flex: 1;
            padding: 14px 18px;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 52px;
            max-height: 200px;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            line-height: 1.5;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary), 0.1);
        }
        
        textarea::placeholder {
            color: var(--text-muted);
        }
        
        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        #voice-btn {
            min-width: 52px;
            min-height: 52px;
            padding: 12px;
            border-radius: 50%;
            font-size: 1.5rem;
            background: var(--button-bg);
            border: 2px solid var(--border-color);
            position: relative;
        }
        
        #voice-btn.recording {
            background: #ff0000;
            color: #ffffff;
            animation: recordingPulse 1.5s infinite;
            border-color: #ff0000;
        }
        
        /* Live Transcription Overlay */
        .transcription-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
        }
        
        .transcription-overlay.active {
            display: flex;
        }
        
        .transcription-content {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        
        .transcription-text {
            font-size: 2rem;
            line-height: 1.4;
            color: var(--accent-primary);
            text-shadow: 0 0 20px var(--accent-primary);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .transcription-status {
            font-size: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }
        
        .recording-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            animation: recordingBlink 1s infinite;
        }
        
        @keyframes recordingBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes recordingPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 var(--accent-primary);
            }
            50% {
                box-shadow: 0 0 0 10px transparent;
            }
        }
        
        #send-btn {
            min-width: 52px;
            min-height: 52px;
            border-radius: var(--border-radius-md);
        }
        
        /* ========================================
           SETTINGS PANEL (Glassmorphism Design)
           ======================================== */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            z-index: 999;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .settings-overlay.active {
            display: block;
            opacity: 1;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            max-width: 450px;
            width: 90%;
            height: 100vh;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: var(--spacing-xl);
            overflow-y: auto;
            z-index: 1000;
            transition: right var(--transition-slow);
            box-shadow: -4px 0 32px rgba(0, 0, 0, 0.5);
        }
        
        .settings-panel.active {
            right: 0;
        }
        
        .settings-section {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(10px);
        }
        
        .settings-section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .settings-section-icon {
            font-size: 1.25rem;
        }
        
        .settings-panel h2 {
            margin-bottom: var(--spacing-lg);
            font-size: 1.5rem;
            color: var(--text-primary);
        }
        
        .setting-group {
            margin-bottom: var(--spacing-md);
        }
        
        .setting-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* Theme Previews */
        .theme-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: background var(--transition-fast);
        }
        
        .theme-preview {
            display: flex;
            gap: 2px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .theme-swatch {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.938rem;
            font-family: inherit;
            transition: border-color var(--transition-fast);
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .settings-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }
        
        .settings-actions button {
            flex: 1;
        }
        
        .about-section {
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }
        
        .about-section h3 {
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
            color: var(--text-primary);
        }
        
        .about-section p {
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        /* ========================================
           UPGRADE MODE STYLES
           ======================================== */
        .upgrade-mode-active .header {
            background: linear-gradient(135deg, rgba(255, 100, 0, 0.2), rgba(255, 0, 100, 0.2));
            animation: warningPulse 2s infinite;
            border-bottom-color: var(--accent-primary);
        }
        
        @keyframes warningPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }
        
        /* ========================================
           RESPONSIVE DESIGN (Mobile-First)
           ======================================== */
        @media (max-width: 767px) {
            :root {
                --spacing-lg: 16px;
                --spacing-xl: 24px;
            }
            
            .header {
                padding: var(--spacing-md);
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-left {
                width: 100%;
                justify-content: space-between;
            }
            
            h1 {
                font-size: 1.25rem;
            }
            
            .status-bar {
                width: 100%;
                justify-content: space-between;
                gap: var(--spacing-sm);
            }
            
            .status-item {
                padding: 4px 10px;
                font-size: 0.75rem;
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
            
            button {
                padding: 8px 14px;
                font-size: 0.813rem;
            }
            
            .chat-container {
                padding: var(--spacing-md);
            }
            
            .message {
                max-width: 100%;
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .input-container {
                padding: var(--spacing-md);
            }
            
            .input-wrapper {
                gap: var(--spacing-sm);
            }
            
            textarea {
                padding: 12px 14px;
                font-size: 1rem;
                border-radius: var(--border-radius-sm);
            }
            
            #voice-btn {
                min-width: 48px;
                min-height: 48px;
                font-size: 1.25rem;
            }
            
            #send-btn {
                min-width: 48px;
                min-height: 48px;
                padding: 8px 12px;
            }
            
            .settings-panel {
                max-width: 100%;
                width: 100%;
                padding: var(--spacing-lg);
            }
        }
        
        /* Tablet */
        @media (min-width: 768px) and (max-width: 1024px) {
            .header {
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .message {
                max-width: 90%;
            }
        }
        
        /* Landscape mobile fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            h1 {
                font-size: 1.125rem;
            }
            
            .status-bar {
                display: none;
            }
            
            .chat-container {
                padding: var(--spacing-sm) var(--spacing-md);
            }
        }
        
        /* Touch device optimization */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            .status-item {
                min-height: 36px;
            }
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* ========================================
           SCROLL TO BOTTOM BUTTON
           ======================================== */
        .scroll-to-bottom {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--button-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            z-index: 50;
            transition: all var(--transition-fast);
        }
        
        .scroll-to-bottom:hover {
            background: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .scroll-to-bottom.visible {
            display: flex;
        }
        
        @media (max-width: 767px) {
            .scroll-to-bottom {
                bottom: 100px;
                right: 16px;
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body class="theme-matrix">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="connection-status" id="connection-status" title="Connected"></div>
            <h1>🤖 Omnibot</h1>
        </div>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">LLM:</span>
                <span class="status-value" id="llm-status">---</span>
            </div>
            <div class="status-item">
                <span class="status-label">Usage:</span>
                <span class="status-value" id="usage-status">0/0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Mode:</span>
                <span class="status-value" id="mode-status">Normal</span>
            </div>
        </div>
        <div class="controls">
            <button id="status-btn" title="Refresh Status" aria-label="Refresh status">
                📊 Status
            </button>
            <button id="settings-btn" title="Settings" aria-label="Open settings">
                ⚙️ Settings
            </button>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chat-container">
        <div class="message system">
            <div>🚀 System Initialized</div>
            <div style="margin-top: 10px; font-size: 0.875rem; opacity: 0.8;">
                Type or click the microphone to speak. Say "upgrade mode" to enable system modifications.
            </div>
        </div>
    </div>

    <!-- Scroll to Bottom Button -->
    <button class="scroll-to-bottom" id="scroll-to-bottom" aria-label="Scroll to bottom">
        ↓
    </button>

    <!-- Live Transcription Overlay -->
    <div class="transcription-overlay" id="transcription-overlay">
        <div class="transcription-content">
            <div class="transcription-text" id="transcription-text">
                Listening...
            </div>
            <div class="transcription-status">
                <div class="recording-indicator"></div>
                <span>Speak now - Click anywhere to cancel</span>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="input-container">
        <div class="input-inner">
            <!-- Secondary Action Buttons -->
            <div class="secondary-actions">
                <button class="secondary-btn" id="code-btn" title="Code mode" aria-label="Toggle code mode">
                    </> Code
                </button>
                <button class="secondary-btn" id="translate-btn" title="Translate" aria-label="Toggle translate mode">
                    🌐 Translate
                </button>
                <button class="secondary-btn" id="swarm-btn" title="Swarm mode" aria-label="Toggle swarm mode">
                    🔗 Swarm
                </button>
                <button class="secondary-btn" id="upgrade-mode-btn" title="Upgrade mode" aria-label="Toggle upgrade mode">
                    🔧 Upgrade
                </button>
            </div>
            
            <!-- Primary Input Row -->
            <div class="input-wrapper">
                <textarea 
                    id="message-input" 
                    placeholder="Type your message or click 🎤 to speak..."
                    rows="1"
                    aria-label="Message input"
                ></textarea>
                <div class="voice-controls">
                    <button id="voice-btn" title="Click to speak" aria-label="Voice input">
                        🎤
                    </button>
                    <button id="send-btn" title="Send message" aria-label="Send message">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settings-overlay"></div>
    <div class="settings-panel" id="settings-panel">
        <h2>⚙️ Settings</h2>
        
        <!-- Theme Settings Section -->
        <div class="settings-section">
            <div class="settings-section-header">
                <span class="settings-section-icon">🎨</span>
                <span>Theme Settings</span>
            </div>
            <div class="setting-group">
                <label class="setting-label" for="theme-select">Visual Theme</label>
                <select id="theme-select">
                    <option value="matrix">Matrix (Green Terminal)</option>
                    <option value="cyberpunk">Cyberpunk (Neon Pink/Cyan)</option>
                    <option value="borg">Borg (Assimilation Green)</option>
                    <option value="hal">HAL 9000 (Menacing Red)</option>
                    <option value="wargames">War Games (Classic Green)</option>
                    <option value="modern">Modern Dark (Blue/Gray)</option>
                    <option value="tron">Tron Legacy (Electric Blue)</option>
                    <option value="neuromancer">Neuromancer (Purple Cyberspace)</option>
                    <option value="alien">Alien Isolation (CRT Green)</option>
                    <option value="dune">Dune (Desert & Spice)</option>
                    <option value="ghost">Ghost in the Shell (Holographic)</option>
                    <option value="interstellar">Interstellar (Deep Space)</option>
                    <option value="synthwave">Synthwave (Retro Neon)</option>
                    <option value="portal">Portal (Aperture Science)</option>
                </select>
            </div>
        </div>
        
        <!-- Connection Settings Section -->
        <div class="settings-section">
            <div class="settings-section-header">
                <span class="settings-section-icon">🔌</span>
                <span>Connection Settings</span>
            </div>
            <div class="setting-group">
                <label class="setting-label" for="router-url">Router URL</label>
                <input 
                    type="text" 
                    id="router-url" 
                    placeholder="https://your-worker.workers.dev"
                    aria-label="Router URL"
                >
            </div>
            
            <div class="setting-group">
                <label class="setting-label" for="secret">Shared Secret</label>
                <input 
                    type="password" 
                    id="secret" 
                    placeholder="Your shared secret key"
                    aria-label="Shared secret"
                >
            </div>
        </div>
        
        <div class="settings-actions">
            <button onclick="saveSettings()">💾 Save</button>
            <button onclick="closeSettings()">✕ Cancel</button>
        </div>
        
        <div class="about-section">
            <h3>🔧 About Upgrade Mode</h3>
            <p>
                <strong>Upgrade Mode</strong> allows you to modify the Omnibot system using natural language.
                <br><br>
                When activated, your next command will be interpreted as a system modification request. 
                The AI will analyze the codebase, make changes, commit to GitHub, and auto-deploy updates.
                <br><br>
                <strong>Examples:</strong><br>
                • "Add a dark mode toggle button"<br>
                • "Make the microphone button larger"<br>
                • "Add conversation export feature"<br>
                • "Change theme colors to blue"
            </p>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            routerUrl: localStorage.getItem('routerUrl') || '',
            secret: localStorage.getItem('secret') || '',
            theme: localStorage.getItem('theme') || 'matrix'
        };
        
        // State
        let conversation = [];
        let recognition = null;
        let currentChallenge = null;
        let upgradeMode = false;
        let isRecording = false;
        let isVoiceInput = false;
        let micPermissionGranted = false;
        let isLoading = false;
        let codeMode = false;
        let translateMode = false;
        let swarmMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupSpeechRecognition();
            setupEventListeners();
            setupScrollBehavior();
            autoResize();
            applyTheme(config.theme);
            
            if (config.routerUrl) {
                updateStatus();
            }
        });

        // Event Listeners Setup
        function setupEventListeners() {
            const input = document.getElementById('message-input');
            const voiceBtn = document.getElementById('voice-btn');
            const sendBtn = document.getElementById('send-btn');
            const themeSelect = document.getElementById('theme-select');

            input.addEventListener('input', () => {
                autoResize();
                updateSendButton();
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            voiceBtn.addEventListener('click', toggleVoice);
            sendBtn.addEventListener('click', sendMessage);
            themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));

            document.getElementById('status-btn').addEventListener('click', updateStatus);
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            document.getElementById('settings-overlay').addEventListener('click', closeSettings);
            document.getElementById('scroll-to-bottom').addEventListener('click', scrollToBottom);
            
            // Secondary action buttons
            document.getElementById('code-btn').addEventListener('click', toggleCodeMode);
            document.getElementById('translate-btn').addEventListener('click', toggleTranslateMode);
            document.getElementById('swarm-btn').addEventListener('click', toggleSwarmMode);
            document.getElementById('upgrade-mode-btn').addEventListener('click', toggleUpgradeMode);
            
            // Transcription overlay click to cancel
            document.getElementById('transcription-overlay').addEventListener('click', () => {
                if (isRecording && recognition) {
                    recognition.stop();
                }
            });
        }

        // Scroll Behavior
        function setupScrollBehavior() {
            const container = document.getElementById('chat-container');
            const scrollBtn = document.getElementById('scroll-to-bottom');
            
            container.addEventListener('scroll', () => {
                const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
                scrollBtn.classList.toggle('visible', !isNearBottom && container.scrollHeight > container.clientHeight);
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }

        function updateSendButton() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = !input.value.trim() && !isRecording;
        }

        // Speech Recognition
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                document.getElementById('voice-btn').disabled = true;
                document.getElementById('voice-btn').title = 'Speech recognition not supported';
                addMessage('system', '⚠️ Voice input not available in this browser. Please use text input.');
                return;
            }

            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                isRecording = true;
                micPermissionGranted = true;
                document.getElementById('voice-btn').classList.add('recording');
                document.getElementById('voice-btn').textContent = '⏹';
                updateSendButton();
            };
            
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('message-input').value = text;
                isVoiceInput = true;
                autoResize();
                updateSendButton();
            };
            
            recognition.onend = () => {
                isRecording = false;
                document.getElementById('voice-btn').classList.remove('recording');
                document.getElementById('voice-btn').textContent = '🎤';
                updateSendButton();
                
                const text = document.getElementById('message-input').value.trim();
                if (text) {
                    sendMessage();
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                document.getElementById('voice-btn').classList.remove('recording');
                document.getElementById('voice-btn').textContent = '🎤';
                updateSendButton();
                
                if (event.error === 'no-speech') {
                    addMessage('system', '🎤 No speech detected. Please try again.');
                } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    addMessage('error', '🔒 Microphone access denied. Please enable microphone permissions in your browser.');
                } else if (event.error !== 'aborted') {
                    addMessage('system', `⚠️ Voice error: ${event.error}`);
                }
            };
        }

        async function toggleVoice() {
            if (!recognition) {
                addMessage('system', '⚠️ Speech recognition not available.');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    isVoiceInput = true;
                    recognition.start();
                } catch (error) {
                    console.error('Recognition start error:', error);
                }
            }
        }

        // Message Sending
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || isLoading) return;
            
            if (!config.routerUrl || !config.secret) {
                addMessage('system', '⚙️ Please configure Router URL and Secret in Settings first.');
                openSettings();
                return;
            }

            input.value = '';
            autoResize();
            updateSendButton();

            addMessage('user', text);
            conversation.push({ role: 'user', content: text });

            const lowerText = text.toLowerCase();
            if (lowerText.includes('upgrade mode')) {
                toggleUpgradeMode();
                const wasVoice = isVoiceInput;
                isVoiceInput = false;
                if (wasVoice) {
                    speak(upgradeMode ? 'Upgrade mode activated.' : 'Normal mode resumed.');
                }
                return;
            }

            showTypingIndicator();
            isLoading = true;

            try {
                currentChallenge = await getChallenge();
                
                let response;
                if (upgradeMode) {
                    response = await sendUpgrade(text);
                    handleUpgradeResponse(response);
                } else {
                    response = await sendChat(text);
                    handleChatResponse(response);
                }
                
                if (isVoiceInput && !upgradeMode) {
                    speak(response.response);
                }
                
            } catch (error) {
                console.error('Send message error:', error);
                if (error.message.includes('Failed to fetch')) {
                    addMessage('error', `❌ Cannot reach server. Check your connection.`);
                } else if (error.message.includes('challenge')) {
                    addMessage('error', `❌ Authentication failed. Check your Shared Secret in Settings.`);
                } else {
                    addMessage('error', `❌ ${error.message}`);
                }
            } finally {
                hideTypingIndicator();
                isVoiceInput = false;
                isLoading = false;
            }
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-container');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // API Calls
        async function getChallenge() {
            const response = await fetch(`${config.routerUrl}/challenge`);
            if (!response.ok) throw new Error('Failed to get authentication challenge');
            return response.json();
        }

        async function sendChat(message) {
            const timestamp = Date.now();
            const signature = await computeSignature(currentChallenge.challenge, timestamp, message);
            
            const response = await fetch(`${config.routerUrl}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Challenge': currentChallenge.challenge,
                    'X-Timestamp': timestamp.toString(),
                    'X-Signature': signature
                },
                body: JSON.stringify({ message, conversation })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }
            return response.json();
        }

        async function sendUpgrade(instruction) {
            const timestamp = Date.now();
            const signature = await computeSignature(currentChallenge.challenge, timestamp, instruction);
            
            const response = await fetch(`${config.routerUrl}/upgrade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Challenge': currentChallenge.challenge,
                    'X-Timestamp': timestamp.toString(),
                    'X-Signature': signature
                },
                body: JSON.stringify({ instruction })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upgrade failed');
            }
            return response.json();
        }

        async function computeSignature(challenge, timestamp, message) {
            const data = `${challenge}|${timestamp}|unknown|${navigator.userAgent}|${JSON.stringify({ message, conversation })}`;
            const encoder = new TextEncoder();
            const key = await crypto.subtle.importKey(
                'raw',
                encoder.encode(config.secret),
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(data));
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Response Handlers
        function handleChatResponse(response) {
            addMessage('assistant', response.response);
            conversation.push({ role: 'assistant', content: response.response });
            
            document.getElementById('llm-status').textContent = response.provider || '---';
            document.getElementById('usage-status').textContent = `${response.usage || 0}/${response.limit || 0}`;
        }

        function handleUpgradeResponse(response) {
            if (response.success) {
                addMessage('system', '✅ Upgrade Successful!');
                if (response.changes) {
                    response.changes.forEach(change => {
                        addMessage('system', `📝 ${change.file}: ${change.reason}`);
                    });
                }
                if (response.deployment_triggered) {
                    addMessage('system', '🚀 Deployment initiated. Changes will be live in ~60 seconds.');
                }
            } else {
                addMessage('error', `❌ Upgrade Failed: ${response.error || 'Unknown error'}`);
            }
            
            if (upgradeMode) {
                toggleUpgradeMode();
            }
        }

        // Upgrade Mode
        function toggleUpgradeMode() {
            upgradeMode = !upgradeMode;
            const modeStatus = document.getElementById('mode-status');
            const upgradeBtn = document.getElementById('upgrade-mode-btn');
            
            if (upgradeMode) {
                document.body.classList.add('upgrade-mode-active');
                modeStatus.textContent = 'UPGRADE';
                modeStatus.style.color = '#ff6600';
                upgradeBtn.classList.add('active');
                addMessage('system', '⚠️ UPGRADE MODE ACTIVATED - Next command will modify the system');
            } else {
                document.body.classList.remove('upgrade-mode-active');
                modeStatus.textContent = 'Normal';
                modeStatus.style.color = '';
                upgradeBtn.classList.remove('active');
                addMessage('system', '✅ Normal mode resumed');
            }
        }

        // Status Update
        async function updateStatus() {
            if (!config.routerUrl) {
                addMessage('error', '⚙️ Configure Router URL in Settings first');
                return;
            }
            
            try {
                const response = await fetch(`${config.routerUrl}/status`);
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => response.statusText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }
                
                const status = await response.json();
                
                let totalUsage = 0;
                let totalLimit = 0;
                let providers = [];
                
                if (status.groq !== undefined) {
                    totalUsage += status.groq;
                    totalLimit += 30;
                    providers.push(`Groq: ${status.groq}/30`);
                }
                if (status.gemini !== undefined) {
                    totalUsage += status.gemini;
                    totalLimit += 15;
                    providers.push(`Gemini: ${status.gemini}/15`);
                }
                if (status.claude !== undefined) {
                    totalUsage += status.claude;
                    totalLimit += 50;
                    providers.push(`Claude: ${status.claude}/50`);
                }
                
                document.getElementById('usage-status').textContent = `${totalUsage}/${totalLimit}`;
                addMessage('system', `📊 ${providers.join(' • ')}`);
            } catch (error) {
                console.error('Status check error:', error);
                if (error.message.includes('Failed to fetch')) {
                    addMessage('error', `❌ Cannot reach ${config.routerUrl}. Check your connection or Router URL.`);
                } else {
                    addMessage('error', `❌ ${error.message}`);
                }
            }
        }

        // Text-to-Speech
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Message Display
        function addMessage(role, content) {
            const container = document.getElementById('chat-container');
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            
            if (role !== 'system' && role !== 'error') {
                const roleLabel = document.createElement('div');
                roleLabel.className = 'message-role';
                roleLabel.textContent = role === 'user' ? 'You' : 'Omnibot';
                msg.appendChild(roleLabel);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            msg.appendChild(contentDiv);
            
            // Add timestamp
            if (role !== 'system') {
                const timestamp = document.createElement('div');
                timestamp.className = 'message-timestamp';
                timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                msg.appendChild(timestamp);
            }
            
            container.appendChild(msg);
            scrollToBottom();
        }

        // Auto-resize Textarea
        function autoResize() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Theme Management
        function applyTheme(theme) {
            document.body.className = `theme-${theme}`;
            const panel = document.getElementById('settings-panel');
            panel.className = `settings-panel theme-${theme}`;
            config.theme = theme;
            localStorage.setItem('theme', theme);
        }

        // Settings Panel
        function openSettings() {
            document.getElementById('settings-panel').classList.add('active');
            document.getElementById('settings-overlay').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-panel').classList.remove('active');
            document.getElementById('settings-overlay').classList.remove('active');
        }

        function loadSettings() {
            document.getElementById('router-url').value = config.routerUrl;
            document.getElementById('secret').value = config.secret;
            document.getElementById('theme-select').value = config.theme;
        }

        function saveSettings() {
            config.routerUrl = document.getElementById('router-url').value.trim();
            config.secret = document.getElementById('secret').value.trim();
            config.theme = document.getElementById('theme-select').value;
            
            localStorage.setItem('routerUrl', config.routerUrl);
            localStorage.setItem('secret', config.secret);
            localStorage.setItem('theme', config.theme);
            
            applyTheme(config.theme);
            addMessage('system', '✅ Settings saved successfully!');
            closeSettings();
            
            if (config.routerUrl) {
                updateStatus();
            }
        }

        // Mode Toggle Functions
        function toggleCodeMode() {
            codeMode = !codeMode;
            document.getElementById('code-btn').classList.toggle('active');
            addMessage('system', codeMode ? '💻 Code mode activated' : '✅ Code mode deactivated');
        }

        function toggleTranslateMode() {
            translateMode = !translateMode;
            document.getElementById('translate-btn').classList.toggle('active');
            addMessage('system', translateMode ? '🌐 Translate mode activated' : '✅ Translate mode deactivated');
        }

        function toggleSwarmMode() {
            swarmMode = !swarmMode;
            document.getElementById('swarm-btn').classList.toggle('active');
            addMessage('system', swarmMode ? '🔗 Swarm mode activated' : '✅ Swarm mode deactivated');
        }
    </script>
</body>
</html>
