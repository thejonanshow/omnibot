#!/usr/bin/env node
/**
 * Build script for modular OmniBot architecture
 * Creates a consolidated worker that embeds the UI HTML for single-file deployment
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const FRONTEND_HTML = path.join(__dirname, '../frontend/index.html');
const OUTPUT_FILE = path.join(__dirname, '../cloudflare-worker/dist/consolidated-worker.js');

console.log('ðŸ”¨ Building modular consolidated worker...');

// Ensure dist directory exists
const distDir = path.dirname(OUTPUT_FILE);
if (!fs.existsSync(distDir)) {
  fs.mkdirSync(distDir, { recursive: true });
}

// Read the HTML template
const frontendHTML = fs.readFileSync(FRONTEND_HTML, 'utf8');

// Escape HTML for embedding in JavaScript
const escapedHTML = frontendHTML
  .replace(/\\/g, '\\\\')     // Escape backslashes first
  .replace(/`/g, '\\`')        // Escape backticks  
  .replace(/\$\{/g, '\\$\\{');  // Escape template literal interpolations

// Build the consolidated worker
const consolidatedWorker = `/**
 * OmniBot - Electric Eel Edition
 * Consolidated Worker for Single-File Deployment
 * 
 * This file is auto-generated by the build process.
 * DO NOT EDIT DIRECTLY - Modify source modules instead.
 */

// Embedded HTML UI Template
const HTML_TEMPLATE = \`${escapedHTML}\`;

// Version Information
const VERSION_FULL = "v1.1.1 Electric Eel";
const VERSION = "1.1.1";

// Core functionality will be embedded here during build
// For now, we'll create a minimal working version

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    // Handle health check
    if (url.pathname === '/health' || url.pathname === '/api/health') {
      return new Response(JSON.stringify({
        status: 'healthy',
        version: VERSION_FULL,
        timestamp: new Date().toISOString()
      }), {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*'
        }
      });
    }
    
    // Handle root path - return embedded HTML
    if (url.pathname === '/') {
      return new Response(HTML_TEMPLATE, {
        headers: {
          'Content-Type': 'text/html;charset=UTF-8',
          'Content-Security-Policy': "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://api.github.com https://api.groq.com https://generativelanguage.googleapis.com https://dashscope.aliyuncs.com",
          'X-Content-Type-Options': 'nosniff',
          'X-Frame-Options': 'DENY',
          'X-XSS-Protection': '1; mode=block',
          'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
        }
      });
    }
    
    // Handle API endpoints with basic functionality
    if (url.pathname === '/api/chat' && request.method === 'POST') {
      try {
        const body = await request.json();
        const { message } = body;
        
        if (!message) {
          return new Response(JSON.stringify({ error: 'Message is required' }), {
            status: 400,
            headers: { 'Content-Type': 'application/json' }
          });
        }
        
        // Simple echo response for now
        return new Response(JSON.stringify({
          response: \`Echo: \${message}\`,
          provider: 'echo',
          timestamp: new Date().toISOString()
        }), {
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*'
          }
        });
      } catch (error) {
        return new Response(JSON.stringify({ error: 'Invalid request' }), {
          status: 400,
          headers: { 'Content-Type': 'application/json' }
        });
      }
    }
    
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
          'Access-Control-Max-Age': '86400'
        }
      });
    }
    
    // 404 for unknown paths
    return new Response('Not Found', { 
      status: 404,
      headers: {
        'Content-Type': 'text/plain',
        'Access-Control-Allow-Origin': '*'
      }
    });
  }
};
`;

// Write the consolidated worker
fs.writeFileSync(OUTPUT_FILE, consolidatedWorker, 'utf8');

console.log('âœ… Modular consolidated worker built successfully');
console.log(`   Worker size: ${consolidatedWorker.length} bytes`);
console.log(`   HTML size: ${escapedHTML.length} bytes`);
console.log(`   Output: ${OUTPUT_FILE}`);

// Also create a package.json for the worker
const workerPackageJson = {
  "name": "omnibot-worker",
  "version": "1.1.1",
  "description": "OmniBot Cloudflare Worker - Electric Eel Edition",
  "main": "dist/consolidated-worker.js",
  "scripts": {
    "deploy": "wrangler deploy dist/consolidated-worker.js",
    "dev": "wrangler dev dist/consolidated-worker.js"
  }
};

fs.writeFileSync(
  path.join(distDir, 'package.json'),
  JSON.stringify(workerPackageJson, null, 2),
  'utf8'
);

console.log('âœ… Package.json created for worker deployment');