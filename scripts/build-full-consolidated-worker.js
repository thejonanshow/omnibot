#!/usr/bin/env node
/**
 * Full Consolidated Worker Build Script
 * Creates a comprehensive consolidated worker with all security features
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const MODULES_DIR = path.join(__dirname, '../cloudflare-worker/src');
const FRONTEND_HTML = path.join(__dirname, '../frontend/index.html');
const OUTPUT_FILE = path.join(__dirname, '../cloudflare-worker/dist/full-consolidated-worker.js');

console.log('üî® Building full consolidated worker with all security features...');

// Ensure dist directory exists
const distDir = path.dirname(OUTPUT_FILE);
if (!fs.existsSync(distDir)) {
  fs.mkdirSync(distDir, { recursive: true });
}

// Read all the modular components
const modules = {};
try {
  modules.config = fs.readFileSync(path.join(MODULES_DIR, 'config.js'), 'utf-8');
  modules.security = fs.readFileSync(path.join(MODULES_DIR, 'security.js'), 'utf-8');
  modules.auth = fs.readFileSync(path.join(MODULES_DIR, 'auth.js'), 'utf-8');
  modules.ai = fs.readFileSync(path.join(MODULES_DIR, 'ai.js'), 'utf-8');
  modules.github = fs.readFileSync(path.join(MODULES_DIR, 'github.js'), 'utf-8');
  modules.context = fs.readFileSync(path.join(MODULES_DIR, 'context.js'), 'utf-8');
  modules.usage = fs.readFileSync(path.join(MODULES_DIR, 'usage.js'), 'utf-8');
  modules.telemetry = fs.readFileSync(path.join(MODULES_DIR, 'telemetry.js'), 'utf-8');
  modules.editor = fs.readFileSync(path.join(MODULES_DIR, 'editor.js'), 'utf-8');
  modules.ui = fs.readFileSync(path.join(MODULES_DIR, 'ui.js'), 'utf-8');
  modules.router = fs.readFileSync(path.join(MODULES_DIR, 'router.js'), 'utf-8');
  
  console.log('‚úì Loaded all modular components');
} catch (error) {
  console.error('‚ùå Failed to load modular components:', error.message);
  process.exit(1);
}

// Read the HTML template
const frontendHTML = fs.readFileSync(FRONTEND_HTML, 'utf8');
console.log('‚úì Loaded frontend HTML template');

// Build the comprehensive consolidated worker
const consolidatedWorker = `/**
 * OmniBot - Electric Eel Edition
 * Full Consolidated Worker with Comprehensive Security
 * 
 * This file is auto-generated by the build process.
 * DO NOT EDIT DIRECTLY - Modify source modules instead.
 * 
 * Features:
 * - Complete security headers including HSTS, CSP, XSS protection
 * - Input validation and sanitization
 * - OAuth authentication with CSRF protection
 * - Rate limiting and circuit breakers
 * - Comprehensive error handling
 * - Full LCARS UI theme
 * - Modular AI provider support
 */

// ===== CONSTANTS AND CONFIGURATION =====
const VERSION_FULL = "v1.1.1 Electric Eel";
const VERSION = "1.1.1";

// Security Configuration
const RATE_LIMIT_WINDOW_MS = 60000; // 1 minute
const RATE_LIMIT_MAX_REQUESTS = 100;
const LOCK_TIMEOUT_MS = 30000; // 30 seconds
const LOCK_RETRY_DELAY_MS = 100; // 100ms

// Embedded HTML UI Template
const HTML_TEMPLATE = \`${frontendHTML.replace(/`/g, '\\`').replace(/\$\{/g, '\\$\\{')}\`;

// ===== SECURITY MODULE =====
${modules.security.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== AUTHENTICATION MODULE =====
${modules.auth.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== AI MODULE =====
${modules.ai.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== GITHUB MODULE =====
${modules.github.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== CONTEXT MODULE =====
${modules.context.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== USAGE MODULE =====
${modules.usage.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== TELEMETRY MODULE =====
${modules.telemetry.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== EDITOR MODULE =====
${modules.editor.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== UI MODULE =====
${modules.ui.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== ROUTER MODULE =====
// Precompute security headers for performance
const SECURITY_HEADERS = {
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
};

const CORS_HEADERS = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Challenge, X-Signature, X-Timestamp',
  ...SECURITY_HEADERS
};

// Initialize rate limiter
const rateLimiter = new RateLimiter(RATE_LIMIT_WINDOW_MS, RATE_LIMIT_MAX_REQUESTS);

${modules.router.replace(/export /g, '').replace(/import .* from .*;/g, '')}

// ===== MAIN EXPORT =====
export default {
  async fetch(request, env) {
    try {
      return await handleRequest(request, env);
    } catch (error) {
      console.error('Worker error:', error);
      return new Response('Internal Server Error', { 
        status: 500,
        headers: {
          'Content-Type': 'text/plain',
          ...SECURITY_HEADERS
        }
      });
    }
  }
};
`;

// Write the comprehensive consolidated worker
fs.writeFileSync(OUTPUT_FILE, consolidatedWorker, 'utf8');

console.log('‚úÖ Full consolidated worker built successfully');
console.log(`   Worker size: ${consolidatedWorker.length} bytes`);
console.log(`   Modules integrated: ${Object.keys(modules).length}`);
console.log(`   Output: ${OUTPUT_FILE}`);

// Create package.json for the worker
const workerPackageJson = {
  "name": "omnibot-worker-full",
  "version": "1.1.1",
  "description": "OmniBot Cloudflare Worker - Full Consolidated Edition",
  "main": "full-consolidated-worker.js",
  "scripts": {
    "deploy": "wrangler deploy full-consolidated-worker.js",
    "dev": "wrangler dev full-consolidated-worker.js"
  }
};

fs.writeFileSync(
  path.join(distDir, 'package-full.json'),
  JSON.stringify(workerPackageJson, null, 2),
  'utf8'
);

console.log('‚úÖ Full package.json created for comprehensive worker deployment');