# OAuth Redirect Loop Fix - December 13, 2024

## Problem Statement

The production version of Omnibot was experiencing a Google OAuth redirect loop. This issue caused users to be caught in a cycle of redirections when attempting to authenticate through Google OAuth.

## Root Cause Analysis

The OAuth implementation had several security and reliability issues:

1. **No State Parameter**: The OAuth flow lacked CSRF protection through state parameter validation
2. **Poor Session Error Handling**: Session validation failures would redirect back to OAuth, potentially causing loops
3. **Insufficient Logging**: No visibility into why session validation was failing

## Solution Implemented

### 1. State Parameter Management (CSRF Protection)

Added two new functions to manage OAuth state:

```javascript
async function generateOAuthState(env)
async function validateOAuthState(state, env)
```

**Key Features:**
- Generates random UUID as state parameter
- Stores state in KV with 5-minute TTL
- One-time use: state is deleted after validation
- ⚠️ **Critical Security Note:** OAuth requests are rejected when KV is unavailable (no fallback to maintain CSRF protection)

### 2. Enhanced Session Validation

Updated `validateSession()` to provide detailed failure reasons:

```javascript
return { 
  valid: false, 
  reason: 'malformed' | 'invalid_signature' | 'expired' | 'unauthorized' | 'error'
}
```

**Benefits:**
- Better debugging through console logging
- Helps identify root cause of session issues
- Enables appropriate error responses

### 3. Redirect Loop Prevention

Changed the behavior when a session parameter is invalid:

**Before:**
```javascript
// Invalid session parameter - redirect to OAuth
return Response.redirect(`${baseUrl}/auth/google`, 302);
```

**After:**
```javascript
// Show error page instead of redirecting
return new Response(`
  <html>
    <head><title>Authentication Error</title></head>
    <body>
      <h1>⚠️ Authentication Error</h1>
      <p>Your session could not be validated (${result.reason}).</p>
      <p><a href="${baseUrl}/auth/google">Try again</a></p>
    </body>
  </html>
`, { status: 401 });
```

**Benefits:**
- Breaks the redirect loop
- Provides user feedback
- Offers manual retry option

## Changes Made

### Modified Functions

1. **`getGoogleAuthUrl(env, redirectUri, state)`**
   - Added `state` parameter
   - Includes state in OAuth URL

2. **`validateSession(token, env)`**
   - Enhanced logging with `console.warn()` and `console.error()`
   - Returns detailed failure reasons
   - Better error messages

3. **OAuth Routes**
   - `/auth/google`: Generates and uses state parameter
   - `/auth/callback`: Validates state before proceeding
   - `/`: Shows error page instead of redirecting on invalid session

### New Functions

1. **`generateOAuthState(env)`**
   - Generates random UUID
   - Stores in KV with 5-minute TTL
   - Returns state string

2. **`validateOAuthState(state, env)`**
   - Validates state exists in KV
   - Deletes state after use (one-time token)
   - Returns boolean

## Testing

Created comprehensive test suite in `tests/oauth-flow.test.js`:

- **State Parameter Management** (4 tests)
  - Validates state functions exist
  - Checks KV storage
  - Verifies state in auth URL
  - Confirms validation in callback

- **OAuth Endpoints** (3 tests)
  - Tests `/auth/google` state generation
  - Validates callback rejects missing state
  - Ensures callback rejects invalid state

- **Session Validation** (2 tests)
  - Confirms enhanced logging
  - Validates error page prevention

- **Redirect Loop Prevention** (2 tests)
  - Shows error page on invalid session
  - Redirects to OAuth only when appropriate

- **Session Cookie Handling** (2 tests)
  - Validates secure cookie attributes
  - Tests cookie and header reading

- **Security** (3 tests)
  - One-time use validation
  - State expiration
  - Error logging

- **Error Messages** (2 tests)
  - User-friendly messages
  - Detailed failure reasons

**Total: 18 tests, all passing**

## Security Improvements

1. **CSRF Protection**: State parameter prevents cross-site request forgery
2. **One-Time Tokens**: State can only be used once
3. **Time-Limited**: State expires after 5 minutes
4. **Secure Cookies**: HttpOnly, Secure, SameSite=Strict
5. **Better Logging**: Enhanced visibility for security debugging

## Backward Compatibility

- Existing session tokens continue to work
- No changes to session format or validation logic (except enhanced logging)
- Graceful degradation when KV is unavailable
- All existing tests continue to pass

## Deployment Notes

1. **KV Namespace Required**: The state validation requires the CONTEXT KV namespace
2. **No Environment Variables Added**: Uses existing `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`
3. **Logging**: New console warnings/errors help debug issues
4. **Error Pages**: Users see friendly error messages instead of loops

## Verification Checklist

- [x] All existing tests pass
- [x] New OAuth tests pass (18/18)
- [x] Linter passes (warnings only)
- [x] Structure tests pass
- [x] Worker builds successfully
- [ ] Deployed to staging
- [ ] Manual OAuth flow tested
- [ ] Production deployment

## Follow-Up Items

1. Monitor OAuth logs for state validation failures
2. Track session validation failure reasons
3. Consider adding rate limiting for OAuth attempts
4. Add E2E tests for full OAuth flow (requires real OAuth credentials)

## Related Files

- `cloudflare-worker/src/index.js` - Main worker with OAuth logic
- `tests/oauth-flow.test.js` - New OAuth test suite
- `tests/auth.test.js` - Existing auth tests (unchanged)
- `tests/e2e/auth.spec.js` - E2E auth tests (unchanged)

## References

- OAuth 2.0 State Parameter: https://www.rfc-editor.org/rfc/rfc6749#section-10.12
- OWASP CSRF Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html
